<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Rizi</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/owner.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

<nav class="nav">
    <div class="container nav__inner">
        <a href="/" class="nav__logo"><img src="/static/images/logo.png" alt="Rizi" class="nav__logo-img"> Rizi</a>
        <div class="nav__actions">
            <button class="btn btn--icon" onclick="toggleLanguage()"><span id="langLabel">EN</span></button>
            <button class="btn btn--icon" onclick="toggleTheme()"><i data-lucide="sun"></i></button>
            <div id="userMenu" class="nav__user" onclick="toggleUserDropdown()">
                <img id="userAvatar" src="" alt="" class="nav__avatar">
                <span id="userName"></span>
            </div>
        </div>
    </div>
</nav>

<main class="owner-page">
    <div class="container">

        <!-- Stats Cards -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <i data-lucide="building-2"></i>
                <div>
                    <span id="statPlaces" class="stat-value">0</span>
                    <label>ÙˆØ­Ø¯Ø§ØªÙŠ</label>
                </div>
            </div>
            <div class="stat-card">
                <i data-lucide="calendar-check"></i>
                <div>
                    <span id="statBookings" class="stat-value">0</span>
                    <label>Ø­Ø¬ÙˆØ²Ø§Øª Ù†Ø´Ø·Ø©</label>
                </div>
            </div>
            <div class="stat-card">
                <i data-lucide="star"></i>
                <div>
                    <span id="statRating" class="stat-value">â€”</span>
                    <label>Ù…ØªÙˆØ³Ø· Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</label>
                </div>
            </div>
            <div class="stat-card">
                <i data-lucide="banknote"></i>
                <div>
                    <span id="statRevenue" class="stat-value">Ù </span>
                    <label>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</label>
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="owner-tabs">
            <button class="tab active" onclick="showTab('properties', this)">
                <i data-lucide="home"></i> ÙˆØ­Ø¯Ø§ØªÙŠ
            </button>
            <button class="tab" onclick="showTab('bookings', this)">
                <i data-lucide="calendar"></i> Ø§Ù„Ø­Ø¬ÙˆØ²Ø§Øª
            </button>
        </div>

        <!-- Properties Tab -->
        <div id="tabProperties" class="tab-content active">
            <div class="tab-header">
                <h2>ÙˆØ­Ø¯Ø§ØªÙŠ Ø§Ù„Ø³ÙƒÙ†ÙŠØ©</h2>
                <button class="btn btn--primary" onclick="showAddProperty()">
                    <i data-lucide="plus"></i> Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø© Ø³ÙƒÙ†ÙŠØ©
                </button>
            </div>
            <div id="propertiesList" class="properties-list">
                <div class="loading-spinner"></div>
            </div>
        </div>

        <!-- Bookings Tab -->
        <div id="tabBookings" class="tab-content">
            <h2>Ø­Ø¬ÙˆØ²Ø§Øª Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
            <div id="ownerBookingsList" class="bookings-list">
                <div class="loading-spinner"></div>
            </div>
        </div>

    </div>
</main>

<!-- â”€â”€â”€ ADD PROPERTY MODAL â”€â”€â”€ -->
<div id="addPropertyModal" class="modal" style="display:none">
    <div class="modal__backdrop" onclick="closeAddProperty()"></div>
    <div class="modal__content modal__content--lg" style="max-width:720px;max-height:90vh;overflow-y:auto;">
        <h2 style="margin-bottom:1.5rem;"><i data-lucide="plus-circle" style="width:24px;height:24px;display:inline;vertical-align:middle;"></i> Ø¥Ø¶Ø§ÙØ© ÙˆØ­Ø¯Ø© Ø³ÙƒÙ†ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©</h2>
        <form id="addPropertyForm" onsubmit="submitProperty(event)">
            <!-- Step indicator -->
            <div class="form-steps" style="display:flex;gap:0.5rem;margin-bottom:1.5rem;">
                <span class="form-step active" data-step="1">Ù¡. Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</span>
                <span class="form-step" data-step="2">Ù¢. Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„Ù…Ø±Ø§ÙÙ‚</span>
                <span class="form-step" data-step="3">Ù£. Ø§Ù„ØµÙˆØ± ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹</span>
            </div>

            <!-- Step 1: Basic Info -->
            <div id="formStep1" class="form-step-content active">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø¹Ø±Ø¨ÙŠ) *</label>
                        <input type="text" name="title_ar" class="form-input" required placeholder="Ù…Ø«Ø§Ù„: Ø´Ù‚Ø© ÙØ§Ø®Ø±Ø© ÙÙŠ Ø­ÙŠ Ø§Ù„Ù†Ø±Ø¬Ø³">
                    </div>
                    <div class="form-group">
                        <label>Title (English) *</label>
                        <input type="text" name="title_en" class="form-input" required placeholder="e.g. Luxury apartment in Al-Narjis">
                    </div>
                    <div class="form-group form-group--full">
                        <label>Ø§Ù„ÙˆØµÙ (Ø¹Ø±Ø¨ÙŠ)</label>
                        <textarea name="description_ar" class="form-input" rows="3" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙØ§Ù‹ Ù…ÙØµÙ„Ø§Ù‹ ÙŠØ´Ù…Ù„ Ø§Ù„Ù…Ù…ÙŠØ²Ø§Øª ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹..."></textarea>
                    </div>
                    <div class="form-group form-group--full">
                        <label>Description (English)</label>
                        <textarea name="description_en" class="form-input" rows="3" placeholder="Write a detailed description..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø³Ø¹Ø± Ù„Ù„ÙŠÙ„Ø© (Ø±.Ø³) *</label>
                        <input type="number" name="price_per_night" class="form-input" min="1" required placeholder="350">
                    </div>
                    <div class="form-group">
                        <label>Ø®ØµÙ… Ø§Ù„Ø¥Ù‚Ø§Ù…Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© (%)</label>
                        <input type="number" name="monthly_discount" class="form-input" min="0" max="50" value="10" placeholder="10">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© *</label>
                        <select name="city_id" class="form-input" id="formCity" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ù†ÙˆØ¹ Ø§Ù„ÙˆØ­Ø¯Ø© *</label>
                        <select name="property_type_id" class="form-input" id="formPropertyType" required>
                            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions" style="justify-content:flex-end;">
                    <button type="button" class="btn btn--primary" onclick="goToStep(2)">Ø§Ù„ØªØ§Ù„ÙŠ <i data-lucide="arrow-left" style="width:16px;height:16px;"></i></button>
                </div>
            </div>

            <!-- Step 2: Details & Amenities -->
            <div id="formStep2" class="form-step-content">
                <div class="form-grid">
                    <div class="form-group">
                        <label>ØºØ±Ù Ø§Ù„Ù†ÙˆÙ…</label>
                        <input type="number" name="bedrooms" class="form-input" min="0" value="1">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø­Ù…Ø§Ù…Ø§Øª</label>
                        <input type="number" name="bathrooms" class="form-input" min="0" value="1">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø£Ø³Ø±Ù‘Ø©</label>
                        <input type="number" name="beds" class="form-input" min="1" value="1">
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¶ÙŠÙˆÙ</label>
                        <input type="number" name="max_guests" class="form-input" min="1" value="4">
                    </div>
                    <div class="form-group">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ø±Ø­Ù„Ø©</label>
                        <select name="trip_type" class="form-input">
                            <option value="both">Ø§Ù„ÙƒÙ„</option>
                            <option value="business">Ø¹Ù…Ù„</option>
                            <option value="family">Ø¹Ø§Ø¦Ù„ÙŠØ©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Ø§Ù„Ø­Ø¬Ø² Ø§Ù„ÙÙˆØ±ÙŠ</label>
                        <select name="is_instant_book" class="form-input">
                            <option value="true">Ù†Ø¹Ù… â€” Ø­Ø¬Ø² ÙÙˆØ±ÙŠ</option>
                            <option value="false">Ù„Ø§ â€” ÙŠØªØ·Ù„Ø¨ Ù…ÙˆØ§ÙÙ‚Ø©</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ÙˆÙ‚Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„</label>
                        <input type="time" name="check_in_time" class="form-input" value="16:00">
                    </div>
                    <div class="form-group">
                        <label>ÙˆÙ‚Øª Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©</label>
                        <input type="time" name="check_out_time" class="form-input" value="12:00">
                    </div>
                    <div class="form-group form-group--full">
                        <label>Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ù…Ù†Ø²Ù„ (Ø¹Ø±Ø¨ÙŠ)</label>
                        <textarea name="rules_ar" class="form-input" rows="2" placeholder="Ù…Ø«Ø§Ù„: Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„ØªØ¯Ø®ÙŠÙ†ØŒ Ù‡Ø§Ø¯Ø¦ Ø¨Ø¹Ø¯ 10 Ù…Ø³Ø§Ø¡Ù‹..."></textarea>
                    </div>
                    <div class="form-group form-group--full">
                        <label>House Rules (English)</label>
                        <textarea name="rules_en" class="form-input" rows="2" placeholder="e.g. No smoking, quiet after 10 PM..."></textarea>
                    </div>
                </div>

                <!-- Amenities Section -->
                <div class="form-group form-group--full" style="margin-top:1rem;">
                    <label style="font-size:1rem;font-weight:700;margin-bottom:0.75rem;display:block;">
                        <i data-lucide="check-circle" style="width:18px;height:18px;display:inline;vertical-align:middle;"></i> Ø§Ù„Ù…Ø±Ø§ÙÙ‚ ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª
                    </label>
                    <div id="amenitiesCheckboxes" class="amenities-checkbox-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:0.5rem;">
                        <p style="color:var(--text-secondary);font-size:0.85rem;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
                    </div>
                </div>

                <div class="form-actions" style="margin-top:1.5rem;">
                    <button type="button" class="btn btn--outline" onclick="goToStep(1)"><i data-lucide="arrow-right" style="width:16px;height:16px;"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                    <button type="button" class="btn btn--primary" onclick="goToStep(3)">Ø§Ù„ØªØ§Ù„ÙŠ <i data-lucide="arrow-left" style="width:16px;height:16px;"></i></button>
                </div>
            </div>

            <!-- Step 3: Images & Location -->
            <div id="formStep3" class="form-step-content">
                <!-- Image Upload -->
                <div class="form-group form-group--full">
                    <label style="font-size:1rem;font-weight:700;margin-bottom:0.75rem;display:block;">
                        <i data-lucide="image-plus" style="width:18px;height:18px;display:inline;vertical-align:middle;"></i> ØµÙˆØ± Ø§Ù„ÙˆØ­Ø¯Ø©
                    </label>
                    <div id="imageUploadArea" class="image-upload-area" style="border:2px dashed var(--border);border-radius:var(--radius-lg);padding:2rem;text-align:center;cursor:pointer;transition:var(--transition);" onclick="document.getElementById('imageFiles').click()">
                        <i data-lucide="upload-cloud" style="width:48px;height:48px;margin:0 auto 12px;display:block;opacity:0.4;"></i>
                        <p style="margin-bottom:4px;">Ø§Ø¶ØºØ· Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙˆØ± Ø£Ùˆ Ø§Ø³Ø­Ø¨Ù‡Ø§ Ù‡Ù†Ø§</p>
                        <small style="color:var(--text-tertiary);">PNG, JPG, WebP â€” Ø­ØªÙ‰ 16 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª Ù„ÙƒÙ„ ØµÙˆØ±Ø©</small>
                    </div>
                    <input type="file" id="imageFiles" accept="image/*" multiple style="display:none;" onchange="previewImages(event)">
                    <div id="imagePreviews" style="display:flex;flex-wrap:wrap;gap:0.75rem;margin-top:1rem;"></div>
                </div>

                <!-- Location -->
                <div class="form-grid" style="margin-top:1.5rem;">
                    <div class="form-group form-group--full">
                        <label>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                        <input type="text" name="address" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ø­ÙŠ Ø§Ù„Ù†Ø±Ø¬Ø³ØŒ Ø´Ø§Ø±Ø¹ Ø§Ù„Ø£Ù…ÙŠØ± Ù…Ø­Ù…Ø¯">
                    </div>
                    <div class="form-group">
                        <label>Ø®Ø· Ø§Ù„Ø¹Ø±Ø¶ (Latitude)</label>
                        <input type="number" name="latitude" class="form-input" step="any" placeholder="24.7136">
                    </div>
                    <div class="form-group">
                        <label>Ø®Ø· Ø§Ù„Ø·ÙˆÙ„ (Longitude)</label>
                        <input type="number" name="longitude" class="form-input" step="any" placeholder="46.6753">
                    </div>
                    <div class="form-group">
                        <label>Ø±Ù‚Ù… Ø§Ù„Ø·Ø§Ø¨Ù‚</label>
                        <input type="text" name="floor_number" class="form-input" placeholder="Ù…Ø«Ø§Ù„: 3">
                    </div>
                    <div class="form-group">
                        <label>ÙˆØµÙ Ø§Ù„Ø¨Ø§Ø¨ (Ø¹Ø±Ø¨ÙŠ)</label>
                        <input type="text" name="door_description_ar" class="form-input" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„Ø¨Ø§Ø¨ Ø§Ù„Ø£ÙŠØ³Ø±">
                    </div>
                    <div class="form-group form-group--full">
                        <label>ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ÙˆØµÙˆÙ„ (Ø¹Ø±Ø¨ÙŠ)</label>
                        <textarea name="access_instructions_ar" class="form-input" rows="2" placeholder="Ø³ÙŠØªÙ… Ø¥Ø¸Ù‡Ø§Ø±Ù‡Ø§ ÙÙ‚Ø· Ø¨Ø¹Ø¯ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²..."></textarea>
                    </div>
                </div>

                <div class="form-actions" style="margin-top:1.5rem;">
                    <button type="button" class="btn btn--outline" onclick="goToStep(2)"><i data-lucide="arrow-right" style="width:16px;height:16px;"></i> Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
                    <button type="button" class="btn btn--outline" onclick="closeAddProperty()">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="submit" class="btn btn--primary" id="submitPropertyBtn">
                        <i data-lucide="check" style="width:16px;height:16px;"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<script src="/static/js/config.js"></script>
<script src="/static/js/i18n.js"></script>
<script src="/static/js/auth.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        applyTranslations();
        if (!Auth.isLoggedIn()) return window.location.href = '/login';
        if (!Auth.isOwner()) {
            showToast('Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø© Ù„Ù„Ù…Ø§Ù„ÙƒÙŠÙ† ÙÙ‚Ø·', 'error');
            return window.location.href = '/';
        }
        loadOwnerData();
    });

    async function loadOwnerData() {
        const user = Auth.getUser();
        loadMyProperties(user.id);
        loadOwnerBookings();
        loadCityOptions();
    }

    async function loadMyProperties(userId) {
        const data = await api.get(`/users/${userId}/places`);
        const list = document.getElementById('propertiesList');
        const lang = getLang();
        const isAr = lang === 'ar';

        if (!data?.length) {
            list.innerHTML = '<div class="empty-state"><i data-lucide="home"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ø³ÙƒÙ†ÙŠØ© Ø¨Ø¹Ø¯</p></div>';
            lucide.createIcons();
            return;
        }

        document.getElementById('statPlaces').textContent = data.length;

        list.innerHTML = data.map(p => `
            <div class="property-item">
                <img src="${p.image_url || CONFIG.PLACEHOLDER_IMAGE}" alt="">
                <div class="property-item__info">
                    <h3>${isAr ? (p.title_ar || p.title_en) : (p.title_en || p.title_ar)}</h3>
                    <p>${formatPrice(p.price_per_night)} ${t('per_night')}</p>
                    <span class="property-item__rating">â˜… ${p.average_rating?.toFixed(1) || 'â€”'}</span>
                </div>
                <div class="property-item__actions">
                    <a href="/place/${p.id}" class="btn btn--outline btn--sm">Ø¹Ø±Ø¶</a>
                </div>
            </div>
        `).join('');

        lucide.createIcons();
    }

    async function loadOwnerBookings() {
        try {
            const res = await api.get('/owner/bookings');
            const data = Array.isArray(res) ? res : (res?.bookings || []);
            const list = document.getElementById('ownerBookingsList');
            const lang = getLang();
            const isAr = lang === 'ar';

            const active = data.filter(b => ['confirmed', 'checked_in'].includes(b.status));
            document.getElementById('statBookings').textContent = active.length;

            if (!data.length) {
                list.innerHTML = '<div class="empty-state"><i data-lucide="calendar-x2"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª</p></div>';
                lucide.createIcons();
                return;
            }

            list.innerHTML = data.map(b => `
                <div class="booking-item">
                    <div class="booking-item__info">
                        <h3>${b.guest_name || 'Guest'} â€” ${isAr ? (b.place_title_ar || b.place_title || '') : (b.place_title_en || b.place_title || '')}</h3>
                        <p>${new Date(b.check_in).toLocaleDateString()} â†’ ${new Date(b.check_out).toLocaleDateString()}</p>
                        <span class="status-badge status-badge--${b.status === 'confirmed' ? 'success' : b.status === 'pending' ? 'warning' : 'info'}">${b.status}</span>
                    </div>
                    <div class="booking-item__actions">
                        ${b.status === 'pending' ? `<button class="btn btn--primary btn--sm" onclick="confirmBooking('${b.id}')">ØªØ£ÙƒÙŠØ¯</button>` : ''}
                        <span class="booking-item__price">${formatPrice(b.total_price || 0)}</span>
                    </div>
                </div>
            `).join('');

            lucide.createIcons();
        } catch (e) {
            console.error('loadOwnerBookings error:', e);
            const list = document.getElementById('ownerBookingsList');
            list.innerHTML = '<div class="empty-state"><i data-lucide="calendar-x2"></i><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø¬ÙˆØ²Ø§Øª</p></div>';
            lucide.createIcons();
        }
    }

    async function loadCityOptions() {
        const isAr = getLang() === 'ar';

        // Cities
        try {
            const cities = await api.get('/cities');
            const select = document.getElementById('formCity');
            if (cities?.length) {
                select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©</option>' + cities.map(c =>
                    `<option value="${c.id}">${isAr ? c.name_ar : c.name_en}</option>`
                ).join('');
            }
        } catch (e) { console.warn('Failed to load cities', e); }

        // Property Types
        try {
            const types = await api.get('/property-types');
            const typeSelect = document.getElementById('formPropertyType');
            if (types?.length) {
                typeSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù†ÙˆØ¹</option>' + types.map(t =>
                    `<option value="${t.id}">${isAr ? t.name_ar : t.name_en}</option>`
                ).join('');
            }
        } catch (e) { console.warn('Failed to load property types', e); }

        // Amenities
        try {
            const amenities = await api.get('/amenities');
            const container = document.getElementById('amenitiesCheckboxes');
            if (amenities?.length) {
                container.innerHTML = amenities.map(a => `
                    <label style="display:flex;align-items:center;gap:0.5rem;padding:0.5rem 0.75rem;border:1px solid var(--border);border-radius:var(--radius-sm);cursor:pointer;transition:var(--transition);font-size:0.85rem;">
                        <input type="checkbox" name="amenity_ids" value="${a.id}" style="accent-color:var(--primary);width:16px;height:16px;">
                        ${a.icon ? `<i data-lucide="${a.icon}" style="width:16px;height:16px;color:var(--primary);flex-shrink:0;"></i>` : ''}
                        <span>${isAr ? (a.name_ar || a.name) : (a.name_en || a.name)}</span>
                    </label>
                `).join('');
                lucide.createIcons();
            } else {
                container.innerHTML = '<p style="color:var(--text-secondary);font-size:0.85rem;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø§ÙÙ‚ Ù…ØªØ§Ø­Ø©</p>';
            }
        } catch (e) {
            document.getElementById('amenitiesCheckboxes').innerHTML = '<p style="color:var(--text-secondary);font-size:0.85rem;">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø§ÙÙ‚</p>';
        }
    }

    /* â”€â”€â”€ Multi-step form navigation â”€â”€â”€ */
    function goToStep(step) {
        // Validate current step before moving forward
        if (step > 1) {
            const form = document.getElementById('addPropertyForm');
            const currentStep = document.querySelector('.form-step-content.active');
            const inputs = currentStep.querySelectorAll('[required]');
            let valid = true;
            inputs.forEach(inp => {
                if (!inp.value) {
                    inp.style.borderColor = 'var(--danger)';
                    valid = false;
                } else {
                    inp.style.borderColor = '';
                }
            });
            if (!valid) return showToast('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©', 'error');
        }

        document.querySelectorAll('.form-step-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.form-step[data-step]').forEach(el => el.classList.remove('active'));
        document.getElementById(`formStep${step}`).classList.add('active');
        document.querySelector(`.form-step[data-step="${step}"]`).classList.add('active');
        lucide.createIcons();
    }

    /* â”€â”€â”€ Image preview â”€â”€â”€ */
    let selectedFiles = [];

    function previewImages(event) {
        const files = Array.from(event.target.files);
        selectedFiles = selectedFiles.concat(files);
        renderImagePreviews();
    }

    function renderImagePreviews() {
        const container = document.getElementById('imagePreviews');
        container.innerHTML = selectedFiles.map((file, i) => {
            const url = URL.createObjectURL(file);
            return `
                <div style="position:relative;width:100px;height:100px;border-radius:var(--radius-sm);overflow:hidden;border:2px solid var(--border);">
                    <img src="${url}" style="width:100%;height:100%;object-fit:cover;">
                    <button type="button" onclick="removeImage(${i})" style="position:absolute;top:4px;right:4px;width:24px;height:24px;background:rgba(0,0,0,0.6);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:14px;line-height:1;">Ã—</button>
                    ${i === 0 ? '<span style="position:absolute;bottom:0;left:0;right:0;background:var(--primary);color:white;font-size:0.65rem;text-align:center;padding:2px;">ØºÙ„Ø§Ù</span>' : ''}
                </div>
            `;
        }).join('');
    }

    function removeImage(index) {
        selectedFiles.splice(index, 1);
        renderImagePreviews();
    }

    async function confirmBooking(id) {
        const res = await api.post(`/owner/bookings/${id}/confirm`);
        if (res.error) return showToast(res.error, 'error');
        showToast('ØªÙ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø¬Ø²', 'success');
        loadOwnerBookings();
    }

    function showTab(name, btn) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.owner-tabs .tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`tab${name.charAt(0).toUpperCase() + name.slice(1)}`).classList.add('active');
        btn.classList.add('active');
    }

    function showAddProperty() {
        document.getElementById('addPropertyModal').style.display = 'flex';
    }

    function closeAddProperty() {
        document.getElementById('addPropertyModal').style.display = 'none';
    }

    async function submitProperty(e) {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);

        // Build data object
        const data = {};
        for (const [key, value] of formData.entries()) {
            if (key === 'amenity_ids') continue; // handle separately
            data[key] = value;
        }

        // Parse numbers
        data.price_per_night = parseFloat(data.price_per_night) || 0;
        data.monthly_discount = parseFloat(data.monthly_discount) || 10;
        data.bedrooms = parseInt(data.bedrooms) || 1;
        data.bathrooms = parseInt(data.bathrooms) || 1;
        data.beds = parseInt(data.beds) || 1;
        data.max_guests = parseInt(data.max_guests) || 4;
        data.latitude = parseFloat(data.latitude) || 0;
        data.longitude = parseFloat(data.longitude) || 0;

        // Amenity IDs
        const amenityCheckboxes = document.querySelectorAll('input[name="amenity_ids"]:checked');
        data.amenity_ids = Array.from(amenityCheckboxes).map(cb => cb.value);

        // Disable submit button
        const submitBtn = document.getElementById('submitPropertyBtn');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="loading-spinner" style="width:16px;height:16px;"></span> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø¶Ø§ÙØ©...';

        try {
            const res = await api.post('/places', data);
            if (res.error) {
                showToast(res.error_ar || res.error, 'error');
                return;
            }

            const placeId = res.place?.id || res.id;

            // Upload images if any
            if (selectedFiles.length > 0 && placeId) {
                for (let i = 0; i < selectedFiles.length; i++) {
                    const imgForm = new FormData();
                    imgForm.append('file', selectedFiles[i]);
                    if (i === 0) imgForm.append('is_cover', 'true');
                    try {
                        await api.upload(`/places/${placeId}/media`, imgForm);
                    } catch (imgErr) {
                        console.warn(`Image ${i + 1} upload failed:`, imgErr);
                    }
                }
            }

            showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø© Ø¨Ù†Ø¬Ø§Ø­! ğŸ‰', 'success');
            closeAddProperty();
            form.reset();
            selectedFiles = [];
            document.getElementById('imagePreviews').innerHTML = '';
            goToStep(1);
            loadOwnerData();
        } catch (err) {
            showToast(err.error_ar || err.error || 'ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i data-lucide="check" style="width:16px;height:16px;"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙˆØ­Ø¯Ø©';
            lucide.createIcons();
        }
    }

    lucide.createIcons();
</script>
</body>
</html>
