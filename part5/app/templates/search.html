<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>البحث — Rizi</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/search.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDKXY_py-Ku0hm_EKZAYV5A86PTpzdNSSY&language=ar"></script>
</head>
<body>

<!-- ─── NAVBAR ─── -->
<nav class="nav">
    <div class="container nav__inner">
        <a href="/" class="nav__logo"><img src="/static/images/logo.png" alt="Rizi" class="nav__logo-img"> Rizi</a>
        <div class="nav__search-mini">
            <input type="text" id="navSearchInput" class="nav__search-input" placeholder="ابحث..." data-t="search_placeholder">
            <button class="btn btn--icon" onclick="doSearch()"><i data-lucide="search"></i></button>
        </div>
        <div class="nav__actions">
            <button class="btn btn--icon" onclick="toggleLanguage()"><span id="langLabel">EN</span></button>
            <button class="btn btn--icon" onclick="toggleTheme()"><i data-lucide="sun"></i></button>
            <a href="/login" id="loginBtn" class="btn btn--primary btn--sm" data-t="login">تسجيل الدخول</a>
            <div id="userMenu" class="nav__user" style="display:none" onclick="toggleUserDropdown()">
                <img id="userAvatar" src="" alt="" class="nav__avatar">
                <span id="userName"></span>
            </div>
        </div>
    </div>
</nav>

<main class="search-page">
    <div class="search-layout">

        <!-- Sidebar: Filters -->
        <aside class="search-filters">
            <h2><i data-lucide="sliders-horizontal"></i> الفلاتر</h2>

            <!-- City -->
            <div class="filter-group">
                <label>المدينة</label>
                <select id="filterCity" class="form-input" onchange="applyFilters()">
                    <option value="">الكل</option>
                </select>
            </div>

            <!-- Property Type -->
            <div class="filter-group">
                <label>نوع العقار</label>
                <select id="filterType" class="form-input" onchange="applyFilters()">
                    <option value="">الكل</option>
                </select>
            </div>

            <!-- Price Range -->
            <div class="filter-group">
                <label>السعر لليلة (ر.س)</label>
                <div class="price-range">
                    <input type="number" id="filterPriceMin" class="form-input" placeholder="من" min="0">
                    <span>—</span>
                    <input type="number" id="filterPriceMax" class="form-input" placeholder="إلى">
                </div>
            </div>

            <!-- Dates -->
            <div class="filter-group">
                <label data-t="check_in">الوصول</label>
                <input type="date" id="filterCheckIn" class="form-input">
            </div>
            <div class="filter-group">
                <label data-t="check_out">المغادرة</label>
                <input type="date" id="filterCheckOut" class="form-input">
            </div>

            <!-- Guests -->
            <div class="filter-group">
                <label data-t="guests">الضيوف</label>
                <input type="number" id="filterGuests" class="form-input" min="1" max="20" value="1">
            </div>

            <!-- Trip Type -->
            <div class="filter-group">
                <label>نوع الرحلة</label>
                <div class="filter-chips">
                    <button class="chip" data-trip="" onclick="setTrip(this)">الكل</button>
                    <button class="chip" data-trip="business" onclick="setTrip(this)">عمل</button>
                    <button class="chip" data-trip="family" onclick="setTrip(this)">عائلية</button>
                </div>
            </div>

            <button class="btn btn--primary btn--block" onclick="applyFilters()">
                <i data-lucide="search"></i> بحث
            </button>
            <button class="btn btn--outline btn--block" onclick="resetFilters()" style="margin-top:0.5rem;">
                مسح الفلاتر
            </button>
        </aside>

        <!-- Main: Results -->
        <div class="search-results">
            <div class="search-results__header">
                <h1 id="resultsTitle">نتائج البحث</h1>
                <span id="resultsCount" class="results-count"></span>
                <div class="sort-controls">
                    <select id="sortBy" class="form-input" onchange="applyFilters()">
                        <option value="">الترتيب</option>
                        <option value="price_asc">السعر: الأقل</option>
                        <option value="price_desc">السعر: الأعلى</option>
                        <option value="rating">التقييم</option>
                        <option value="newest">الأحدث</option>
                    </select>
                </div>
            </div>

            <!-- Map toggle -->
            <div class="map-toggle">
                <button class="btn btn--outline btn--sm" onclick="toggleMap()">
                    <i data-lucide="map"></i> <span id="mapToggleLabel">عرض الخريطة</span>
                </button>
            </div>

            <!-- Map (hidden by default) -->
            <div id="searchMap" class="search-map" style="display:none"></div>

            <!-- Grid -->
            <div id="placesGrid" class="places-grid">
                <div class="loading-spinner"></div>
            </div>

            <!-- Pagination -->
            <div id="pagination" class="pagination"></div>
        </div>
    </div>
</main>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="/static/js/config.js"></script>
<script src="/static/js/i18n.js"></script>
<script src="/static/js/auth.js"></script>
<script>
    let searchMap = null;
    let searchMarkers = [];
    let currentTrip = '';
    let currentPage = 1;
    let filtersReady = false;
    let currentPlaces = []; // To store latest search results for map toggle

    document.addEventListener('DOMContentLoaded', async () => {
        applyTranslations();
        await loadFilters();
        filtersReady = true;
        readURLParams();
        applyFilters();
    });

    // Populate filter dropdowns
    async function loadFilters() {
        const lang = getLang();
        const isAr = lang === 'ar';

        // Cities
        try {
            const cities = await api.get('/cities');
            const citySelect = document.getElementById('filterCity');
            if (cities?.length) {
                cities.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.id;
                    opt.textContent = isAr ? (c.name_ar || c.name_en) : (c.name_en || c.name_ar);
                    citySelect.appendChild(opt);
                });
            }
        } catch(e) { console.warn('Cities load failed', e); }

        // Property Types
        try {
            const types = await api.get('/property-types');
            const typeSelect = document.getElementById('filterType');
            if (types?.length) {
                types.forEach(tp => {
                    const opt = document.createElement('option');
                    opt.value = tp.id;
                    opt.textContent = isAr ? (tp.name_ar || tp.name_en) : (tp.name_en || tp.name_ar);
                    typeSelect.appendChild(opt);
                });
            }
        } catch(e) { console.warn('Types load failed', e); }

        // Set min date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('filterCheckIn').min = today;
        document.getElementById('filterCheckOut').min = today;
    }

    function readURLParams() {
        const params = new URLSearchParams(window.location.search);

        // city param — the home page sends city=<UUID>
        const cityParam = params.get('city') || params.get('city_id');
        if (cityParam) document.getElementById('filterCity').value = cityParam;

        // property type
        const typeParam = params.get('type') || params.get('property_type_id');
        if (typeParam) document.getElementById('filterType').value = typeParam;

        if (params.get('check_in')) document.getElementById('filterCheckIn').value = params.get('check_in');
        if (params.get('check_out')) document.getElementById('filterCheckOut').value = params.get('check_out');
        if (params.get('guests')) document.getElementById('filterGuests').value = params.get('guests');

        // text search
        const q = params.get('q');
        if (q) document.getElementById('navSearchInput').value = q;

        // price
        if (params.get('min_price')) document.getElementById('filterPriceMin').value = params.get('min_price');
        if (params.get('max_price')) document.getElementById('filterPriceMax').value = params.get('max_price');

        // sort
        if (params.get('sort')) document.getElementById('sortBy').value = params.get('sort');

        // trip_type
        if (params.get('trip_type')) {
            currentTrip = params.get('trip_type');
            document.querySelectorAll('.chip').forEach(c => c.classList.toggle('active', c.dataset.trip === currentTrip));
        }

        // Update title with city name if set
        const citySelect = document.getElementById('filterCity');
        if (citySelect.value) {
            const selectedOption = citySelect.options[citySelect.selectedIndex];
            if (selectedOption && selectedOption.text !== 'الكل') {
                document.getElementById('resultsTitle').textContent = `نتائج البحث — ${selectedOption.text}`;
            }
        }
    }

    async function applyFilters() {
        const params = new URLSearchParams();
        const city = document.getElementById('filterCity').value;
        const type = document.getElementById('filterType').value;
        const priceMin = document.getElementById('filterPriceMin').value;
        const priceMax = document.getElementById('filterPriceMax').value;
        const checkIn = document.getElementById('filterCheckIn').value;
        const checkOut = document.getElementById('filterCheckOut').value;
        const guests = document.getElementById('filterGuests').value;
        const sort = document.getElementById('sortBy').value;
        const search = document.getElementById('navSearchInput').value;

        if (city) params.set('city_id', city);
        if (type) params.set('property_type_id', type);
        if (priceMin) params.set('min_price', priceMin);
        if (priceMax) params.set('max_price', priceMax);
        if (checkIn) params.set('check_in', checkIn);
        if (checkOut) params.set('check_out', checkOut);
        if (guests && guests !== '1') params.set('guests', guests);
        if (currentTrip) params.set('trip_type', currentTrip);
        if (sort) {
            const sortMap = { price_asc: 'price_low', price_desc: 'price_high', rating: 'rating', newest: 'newest' };
            params.set('sort', sortMap[sort] || sort);
        }
        if (search) params.set('q', search);
        params.set('page', currentPage);
        params.set('lang', getLang());

        // Update URL without reload so it's bookmarkable/shareable
        const urlParams = new URLSearchParams();
        if (city) urlParams.set('city', city);
        if (type) urlParams.set('type', type);
        if (priceMin) urlParams.set('min_price', priceMin);
        if (priceMax) urlParams.set('max_price', priceMax);
        if (checkIn) urlParams.set('check_in', checkIn);
        if (checkOut) urlParams.set('check_out', checkOut);
        if (guests && guests !== '1') urlParams.set('guests', guests);
        if (currentTrip) urlParams.set('trip_type', currentTrip);
        if (search) urlParams.set('q', search);
        if (sort) urlParams.set('sort', sort);
        const newUrl = '/search' + (urlParams.toString() ? '?' + urlParams.toString() : '');
        history.replaceState(null, '', newUrl);

        // Update title
        const citySelect = document.getElementById('filterCity');
        if (citySelect.value) {
            const selectedOption = citySelect.options[citySelect.selectedIndex];
            if (selectedOption && selectedOption.text !== 'الكل') {
                document.getElementById('resultsTitle').textContent = `نتائج البحث — ${selectedOption.text}`;
            } else {
                document.getElementById('resultsTitle').textContent = 'نتائج البحث';
            }
        } else {
            document.getElementById('resultsTitle').textContent = 'نتائج البحث';
        }

        const grid = document.getElementById('placesGrid');
        grid.innerHTML = Array(6).fill('').map(() => `
            <div class="place-card" style="pointer-events:none;">
                <div class="skeleton" style="aspect-ratio:4/3;"></div>
                <div style="padding:16px;">
                    <div class="skeleton" style="height:1rem;width:70%;margin-bottom:8px;"></div>
                    <div class="skeleton" style="height:0.8rem;width:40%;"></div>
                </div>
            </div>
        `).join('');

        const data = await api.get(`/places?${params.toString()}`);

        if (!data || (Array.isArray(data) && !data.length)) {
            grid.innerHTML = `
                <div class="empty-state" style="grid-column:1/-1;">
                    <i data-lucide="search-x" style="width:56px;height:56px;margin:0 auto 16px;display:block;opacity:0.4;"></i>
                    <p style="font-size:1.1rem;margin-bottom:8px;">لا توجد نتائج</p>
                    <p style="font-size:0.9rem;color:var(--text-tertiary);">جرّب تعديل الفلاتر أو البحث بكلمات مختلفة</p>
                </div>
            `;
            if (typeof lucide !== 'undefined') lucide.createIcons();
            document.getElementById('resultsCount').textContent = '0 نتيجة';
            return;
        }

        const places = Array.isArray(data) ? data : (data.places || []);
        const total = data.total || places.length;
        currentPlaces = places; // Save for map toggle

        document.getElementById('resultsCount').textContent = `${total} نتيجة`;
        grid.innerHTML = places.map(p => createSearchCard(p)).join('');

        // Map markers (only if map is visible)
        if (searchMap) updateSearchMap(places);

        lucide.createIcons();
    }

    function createSearchCard(p) {
        const lang = getLang();
        const title = lang === 'ar' ? (p.title_ar || p.title_en || p.title) : (p.title_en || p.title_ar || p.title);
        const cityName = p.city ? (lang === 'ar' ? (p.city.name_ar || p.city.name_en || '') : (p.city.name_en || p.city.name_ar || '')) : '';
        const typeName = p.property_type
            ? (lang === 'ar' ? (p.property_type.name_ar || p.property_type.name_en || '') : (p.property_type.name_en || ''))
            : '';
        const image = p.image_url || p.cover_image || CONFIG.PLACEHOLDER_IMAGE;
        const rating = p.average_rating ? p.average_rating.toFixed(1) : null;
        const reviewCount = p.review_count || 0;
        const isFav = (typeof favoriteIds !== 'undefined' && favoriteIds.has(p.id));

        return `
            <a href="/place/${p.id}" class="place-card">
                <div class="place-card-image">
                    <img src="${image}" alt="${title}" loading="lazy">
                    ${p.is_featured ? '<span class="place-card-badge"><i data-lucide="crown" style="width:12px;height:12px;display:inline;"></i> Elite</span>' : ''}
                    <button class="place-card-fav" onclick="event.preventDefault();event.stopPropagation();toggleFavorite('${p.id}', this)">
                        <i data-lucide="heart" style="width:18px;height:18px;${isFav ? 'color:#e11d48;fill:currentColor;' : ''}"></i>
                    </button>
                </div>
                <div class="place-card-body">
                    ${cityName ? `<div class="place-card-location"><i data-lucide="map-pin" style="width:14px;height:14px;flex-shrink:0;"></i> ${cityName}</div>` : ''}
                    <div class="place-card-title">${title}</div>
                    <div class="place-card-info">
                        ${p.bedrooms ? `<span><i data-lucide="bed-double" style="width:14px;height:14px;"></i> ${p.bedrooms}</span>` : ''}
                        ${p.max_guests ? `<span><i data-lucide="users" style="width:14px;height:14px;"></i> ${p.max_guests}</span>` : ''}
                        ${typeName ? `<span>${typeName}</span>` : ''}
                    </div>
                </div>
                <div class="place-card-footer">
                    <span class="place-card-price">${formatPrice(p.price_per_night)} <small>${t('per_night')}</small></span>
                    <span class="place-card-rating">${rating ? `<span class="star">★</span> ${rating}` : '<span style="opacity:0.4;">جديد</span>'} ${reviewCount ? `<small>(${reviewCount})</small>` : ''}</span>
                </div>
            </a>
        `;
    }

    function setTrip(btn) {
        currentTrip = btn.dataset.trip;
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        applyFilters();
    }

    function resetFilters() {
        document.getElementById('filterCity').value = '';
        document.getElementById('filterType').value = '';
        document.getElementById('filterPriceMin').value = '';
        document.getElementById('filterPriceMax').value = '';
        document.getElementById('filterCheckIn').value = '';
        document.getElementById('filterCheckOut').value = '';
        document.getElementById('filterGuests').value = '1';
        document.getElementById('sortBy').value = '';
        document.getElementById('navSearchInput').value = '';
        currentTrip = '';
        document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
        document.querySelector('.chip[data-trip=""]')?.classList.add('active');
        applyFilters();
    }

    function doSearch() {
        currentPage = 1;
        applyFilters();
    }

    // Map
    function toggleMap() {
        const el = document.getElementById('searchMap');
        const visible = el.style.display !== 'none';
        el.style.display = visible ? 'none' : 'block';
        document.getElementById('mapToggleLabel').textContent = visible ? 'عرض الخريطة' : 'إخفاء الخريطة';
        if (!visible && !searchMap) {
            const useGoogle = typeof google !== 'undefined' && google.maps;
            if (useGoogle) {
                searchMap = new google.maps.Map(el, {
                    center: { lat: CONFIG.MAP_CENTER[0], lng: CONFIG.MAP_CENTER[1] },
                    zoom: CONFIG.MAP_ZOOM,
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false,
                    styles: [
                        { featureType: 'poi', stylers: [{ visibility: 'off' }] },
                        { featureType: 'transit', stylers: [{ visibility: 'off' }] }
                    ]
                });
                searchMap._provider = 'google';
            } else {
                searchMap = L.map('searchMap').setView(CONFIG.MAP_CENTER, CONFIG.MAP_ZOOM);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap'
                }).addTo(searchMap);
                searchMap._provider = 'osm';
            }
        }
        if (searchMap) {
            if (searchMap._provider === 'google') {
                setTimeout(() => {
                    google.maps.event.trigger(searchMap, 'resize');
                    searchMap.setZoom(CONFIG.MAP_ZOOM);
                    searchMap.setCenter({ lat: CONFIG.MAP_CENTER[0], lng: CONFIG.MAP_CENTER[1] });
                    updateSearchMap(currentPlaces); // Re-populate with latest results
                }, 200);
            } else {
                setTimeout(() => {
                    searchMap.invalidateSize();
                    updateSearchMap(currentPlaces); // Re-populate
                }, 200);
            }
        }
    }

    function updateSearchMap(places) {
        if (!searchMap) return;
        const isGoogle = searchMap._provider === 'google';

        // Clear markers
        searchMarkers.forEach(m => {
            if (isGoogle) m.setMap(null);
            else searchMap.removeLayer(m);
        });
        searchMarkers = [];

        const bounds = isGoogle ? new google.maps.LatLngBounds() : null;

        // Custom Overlay for Google Maps (Price Pill)
        if (isGoogle && !searchMap._PriceOverlayClass) {
             searchMap._PriceOverlayClass = class extends google.maps.OverlayView {
                constructor(position, content, id) {
                    super();
                    this.position = position;
                    this.content = content;
                    this.id = id;
                    this.div = null;
                }
                onAdd() {
                    this.div = document.createElement('div');
                    this.div.className = 'map-price-marker';
                    this.div.innerHTML = this.content;
                    this.div.title = "Click to view property";
                    // Add click listener to navigate to the place
                    this.div.addEventListener('click', (e) => {
                        e.stopPropagation(); // prevent map click
                        window.location.href = `/place/${this.id}`;
                    });
                    const panes = this.getPanes();
                    panes.overlayMouseTarget.appendChild(this.div);
                }
                draw() {
                    const overlayProjection = this.getProjection();
                    if (!overlayProjection) return;
                    const pos = overlayProjection.fromLatLngToDivPixel(this.position);
                    if (this.div) {
                        this.div.style.left = (pos.x) + 'px';
                        this.div.style.top = (pos.y) + 'px';
                    }
                }
                onRemove() {
                    if (this.div) {
                        this.div.parentNode.removeChild(this.div);
                        this.div = null;
                    }
                }
            };
        }

        places.forEach(p => {
            if (!p.latitude || !p.longitude) return;
            const price = p.price_per_night || p.price || 0;
            const formattedPrice = formatPrice(price);

            if (isGoogle) {
                const latLng = new google.maps.LatLng(p.latitude, p.longitude);
                if (searchMap._PriceOverlayClass) {
                    const overlay = new searchMap._PriceOverlayClass(latLng, formattedPrice, p.id);
                    overlay.setMap(searchMap);
                    searchMarkers.push(overlay);
                } else {
                    // Fallback
                    const marker = new google.maps.Marker({
                        position: latLng,
                        map: searchMap,
                        title: formattedPrice
                    });
                    searchMarkers.push(marker);
                }
                bounds.extend(latLng);
            } else {
                // Leaflet
                const icon = L.divIcon({
                    className: 'map-price-marker-leaflet',
                    html: `<div>${formattedPrice}</div>`,
                    iconSize: [60, 24],
                    iconAnchor: [30, 12]
                });
                const m = L.marker([p.latitude, p.longitude], { icon: icon })
                    .addTo(searchMap)
                    .bindPopup(`<strong>${p.title_en || p.title || p.title_ar}</strong><br>${formattedPrice}`);
                
                m.on('click', () => window.location.href = `/place/${p.id}`);
                searchMarkers.push(m);
            }
        });

        if (searchMarkers.length) {
            if (isGoogle) {
                searchMap.fitBounds(bounds, { padding: 50 });
            } else {
                searchMap.fitBounds(L.featureGroup(searchMarkers).getBounds().pad(0.1));
            }
        }
    }

    lucide.createIcons();
</script>
</body>
</html>
