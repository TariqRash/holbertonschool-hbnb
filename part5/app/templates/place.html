<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rizi â€” ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù‚Ø§Ø±</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/place.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDKXY_py-Ku0hm_EKZAYV5A86PTpzdNSSY&language=ar"></script>
</head>
<body>

<!-- â”€â”€â”€ NAVBAR â”€â”€â”€ -->
<nav class="nav">
    <div class="container nav__inner">
        <a href="/" class="nav__logo"><img src="/static/images/logo.png" alt="Rizi" class="nav__logo-img"> Rizi</a>
        <div class="nav__actions">
            <button class="btn btn--icon" onclick="toggleLanguage()"><span id="langLabel">EN</span></button>
            <button class="btn btn--icon" onclick="toggleTheme()"><i data-lucide="sun"></i></button>
            <a href="/login" id="loginBtn" class="btn btn--primary btn--sm" data-t="login">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</a>
            <div id="userMenu" class="nav__user" style="display:none" onclick="toggleUserDropdown()">
                <img id="userAvatar" src="" alt="" class="nav__avatar">
                <span id="userName"></span>
            </div>
        </div>
    </div>
</nav>

<!-- â”€â”€â”€ PLACE DETAIL â”€â”€â”€ -->
<main class="place-page">
    <div class="container">
        <!-- Loading skeleton -->
        <div id="placeSkeleton" class="skeleton-container">
            <div class="skeleton skeleton--gallery"></div>
            <div class="skeleton skeleton--title"></div>
            <div class="skeleton skeleton--text"></div>
        </div>

        <!-- Content (hidden until loaded) -->
        <div id="placeContent" style="display:none">

            <!-- Gallery -->
            <div id="placeGallery" class="place-gallery"></div>

            <!-- Header -->
            <div class="place-header">
                <div class="place-header__info">
                    <h1 id="placeTitle"></h1>
                    <p id="placeCity" class="place-header__city"></p>
                    <div class="place-header__meta">
                        <span id="placeRating" class="place-rating"></span>
                        <span id="placeReviewCount"></span>
                        <span id="placeType" class="place-type-badge"></span>
                    </div>
                </div>
                <div class="place-header__price">
                    <span id="placePrice" class="place-price"></span>
                    <small data-t="per_night">Ù„Ù„ÙŠÙ„Ø©</small>
                </div>
            </div>

            <!-- Two-column layout -->
            <div class="place-grid">
                <!-- Left: Details -->
                <div class="place-details">
                    <!-- Host -->
                    <div class="place-host" id="placeHost"></div>

                    <!-- Stats -->
                    <div class="place-stats" id="placeStats"></div>

                    <!-- Description -->
                    <section class="place-section">
                        <h2 data-t="description">Ø§Ù„ÙˆØµÙ</h2>
                        <p id="placeDescription"></p>
                    </section>

                    <!-- Amenities -->
                    <section class="place-section">
                        <h2 data-t="amenities">Ø§Ù„Ù…Ø±Ø§ÙÙ‚</h2>
                        <div id="placeAmenities" class="amenities-grid"></div>
                    </section>

                    <!-- Access Instructions (post-booking) -->
                    <section class="place-section" id="accessSection" style="display:none">
                        <h2>ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ÙˆØµÙˆÙ„</h2>
                        <div id="placeAccess" class="access-card"></div>
                    </section>

                    <!-- Map -->
                    <section class="place-section">
                        <h2 data-t="location">Ø§Ù„Ù…ÙˆÙ‚Ø¹</h2>
                        <p id="mapNotice" class="map-notice">ğŸ“ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠ â€” ÙŠØªÙ… Ø§Ù„ÙƒØ´Ù Ø¹Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø¬Ø²</p>
                        <div id="placeMap" class="place-map"></div>
                    </section>

                    <!-- Reviews -->
                    <section class="place-section">
                        <h2 data-t="reviews">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h2>
                        <!-- "Booked here before" badge (shown if user has past booking) -->
                        <div id="bookedBadge" style="display:none;margin-bottom:1rem;">
                            <span style="display:inline-flex;align-items:center;gap:6px;background:#dcfce7;color:#166534;padding:6px 14px;border-radius:20px;font-size:0.85rem;font-weight:600;">
                                <i data-lucide="badge-check" style="width:16px;height:16px;"></i> Ø­Ø¬Ø² Ù‡Ù†Ø§ Ù…Ø³Ø¨Ù‚Ø§Ù‹
                            </span>
                        </div>
                        <div id="placeReviews" class="reviews-list"></div>
                        <!-- Write Review button â€” only for guests who booked and haven't reviewed yet -->
                        <button id="writeReviewBtn" class="btn btn--outline" style="display:none;margin-top:1rem;" onclick="showReviewForm()">
                            <i data-lucide="edit-3"></i> <span data-t="write_review">Ø§ÙƒØªØ¨ ØªÙ‚ÙŠÙŠÙ…</span>
                        </button>
                    </section>
                </div>

                <!-- Right: Booking Card -->
                <aside class="booking-sidebar">
                    <div class="booking-card" id="bookingCard">
                        <div class="booking-card__price">
                            <span id="bookingPrice"></span>
                            <small data-t="per_night">Ù„Ù„ÙŠÙ„Ø©</small>
                        </div>

                        <div class="booking-card__dates">
                            <div class="form-group">
                                <label data-t="check_in">Ø§Ù„ÙˆØµÙˆÙ„</label>
                                <input type="date" id="bookCheckIn" class="form-input">
                            </div>
                            <div class="form-group">
                                <label data-t="check_out">Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø©</label>
                                <input type="date" id="bookCheckOut" class="form-input">
                            </div>
                        </div>

                        <div class="booking-card__guests">
                            <div class="form-group">
                                <label data-t="guests">Ø§Ù„Ø¶ÙŠÙˆÙ</label>
                                <div class="guest-counter">
                                    <button onclick="changeGuests(-1)">âˆ’</button>
                                    <span id="guestCount">1</span>
                                    <button onclick="changeGuests(1)">+</button>
                                </div>
                            </div>
                        </div>

                        <div id="bookingSummary" class="booking-summary" style="display:none">
                            <div class="summary-row">
                                <span id="summaryNights"></span>
                                <span id="summarySubtotal"></span>
                            </div>
                            <div class="summary-row">
                                <span>Ø±Ø³ÙˆÙ… Ø§Ù„Ø®Ø¯Ù…Ø©</span>
                                <span id="summaryFee"></span>
                            </div>
                            <div class="summary-row summary-total">
                                <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</span>
                                <span id="summaryTotal"></span>
                            </div>
                        </div>

                        <button class="btn btn--primary btn--block" onclick="checkAvailability()" id="bookBtn" data-t="book_now">
                            Ø§Ø­Ø¬Ø² Ø§Ù„Ø¢Ù†
                        </button>
                    </div>
                </aside>
            </div>

        </div>
    </div>
</main>

<!-- â”€â”€â”€ REVIEW MODAL â”€â”€â”€ -->
<div id="reviewModal" class="modal" style="display:none">
    <div class="modal__backdrop" onclick="closeReviewModal()"></div>
    <div class="modal__content" style="max-width:500px;">
        <h2 style="margin-bottom:1.5rem;">Ø§ÙƒØªØ¨ ØªÙ‚ÙŠÙŠÙ…Ùƒ</h2>

        <!-- Overall Star Rating -->
        <div class="form-group">
            <label>Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù… *</label>
            <div class="star-rating-input" id="starRating">
                <span class="star" data-val="1" onclick="setRating(1)">â˜…</span>
                <span class="star" data-val="2" onclick="setRating(2)">â˜…</span>
                <span class="star" data-val="3" onclick="setRating(3)">â˜…</span>
                <span class="star" data-val="4" onclick="setRating(4)">â˜…</span>
                <span class="star" data-val="5" onclick="setRating(5)">â˜…</span>
            </div>
        </div>

        <!-- Rating Breakdown -->
        <div class="review-breakdown" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:1rem;">
            <div class="form-group">
                <label style="font-size:0.85rem;">Ø§Ù„Ù†Ø¸Ø§ÙØ© Cleanliness</label>
                <select id="revCleanliness" class="form-input form-input--sm"><option value="">â€”</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
            </div>
            <div class="form-group">
                <label style="font-size:0.85rem;">Ø§Ù„Ø¯Ù‚Ø© Accuracy</label>
                <select id="revAccuracy" class="form-input form-input--sm"><option value="">â€”</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
            </div>
            <div class="form-group">
                <label style="font-size:0.85rem;">Ø§Ù„Ù…ÙˆÙ‚Ø¹ Location</label>
                <select id="revLocation" class="form-input form-input--sm"><option value="">â€”</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
            </div>
            <div class="form-group">
                <label style="font-size:0.85rem;">Ø§Ù„Ù‚ÙŠÙ…Ø© Value</label>
                <select id="revValue" class="form-input form-input--sm"><option value="">â€”</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
            </div>
            <div class="form-group">
                <label style="font-size:0.85rem;">Ø§Ù„ØªÙˆØ§ØµÙ„ Communication</label>
                <select id="revComm" class="form-input form-input--sm"><option value="">â€”</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
            </div>
            <div class="form-group">
                <label style="font-size:0.85rem;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆØµÙˆÙ„ Check-in</label>
                <select id="revCheckin" class="form-input form-input--sm"><option value="">â€”</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option></select>
            </div>
        </div>

        <!-- Comment -->
        <div class="form-group">
            <label>Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</label>
            <textarea id="reviewComment" class="form-input" rows="4" placeholder="Ø´Ø§Ø±ÙƒÙ†Ø§ ØªØ¬Ø±Ø¨ØªÙƒ..."></textarea>
        </div>
        <button class="btn btn--primary btn--block" id="submitReviewBtn" onclick="submitReview()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
    </div>
</div>

<style>
.star-rating-input { display:flex; gap:4px; direction:ltr; font-size:2rem; }
.star-rating-input .star { cursor:pointer; color:#d1d5db; transition:color 0.15s; user-select:none; }
.star-rating-input .star.active { color:#f59e0b; }
.form-input--sm { padding:6px 10px; font-size:0.85rem; }
</style>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="/static/js/config.js"></script>
<script src="/static/js/i18n.js"></script>
<script src="/static/js/auth.js"></script>
<script>
    const placeId = window.location.pathname.split('/place/')[1];
    let placeData = null;
    let guestCount = 1;
    let placeMap = null;

    document.addEventListener('DOMContentLoaded', () => {
        applyTranslations();
        loadPlace();
    });

    async function loadPlace() {
        const lang = getLang();
        placeData = await api.get(`/places/${placeId}?lang=${lang}`);
        if (!placeData || placeData.error) {
            showToast('Ø¹Ù‚Ø§Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', 'error');
            return;
        }

        document.getElementById('placeSkeleton').style.display = 'none';
        document.getElementById('placeContent').style.display = 'block';

        const p = placeData;
        const isAr = lang === 'ar';

        // Title & header
        document.getElementById('placeTitle').textContent = isAr ? (p.title_ar || p.title_en) : (p.title_en || p.title_ar);
        document.getElementById('placeCity').textContent = isAr ? (p.city?.name_ar || p.city?.name_en || '') : (p.city?.name_en || '');
        document.getElementById('placeRating').textContent = `â˜… ${p.average_rating?.toFixed(1) || 'â€”'}`;
        document.getElementById('placeReviewCount').textContent = `(${p.review_count || 0} ${t('reviews')})`;
        document.getElementById('placeType').textContent = isAr ? (p.property_type?.name_ar || p.property_type?.name_en || '') : (p.property_type?.name_en || '');

        // Price
        const price = formatPrice(p.price_per_night);
        document.getElementById('placePrice').textContent = price;
        document.getElementById('bookingPrice').textContent = price;

        // Description
        document.getElementById('placeDescription').textContent = isAr ? (p.description_ar || p.description_en || '') : (p.description_en || '');

        // Gallery
        renderGallery(p.media || []);

        // Host
        if (p.owner) {
            document.getElementById('placeHost').innerHTML = `
                <img src="${p.owner.avatar_url || '/static/images/avatar-default.svg'}" alt="" class="host-avatar">
                <div>
                    <strong>${p.owner.first_name || 'Host'}</strong>
                    <span>Ù…Ø§Ù„Ùƒ Ø§Ù„Ø¹Ù‚Ø§Ø±</span>
                </div>
            `;
        }

        // Stats
        document.getElementById('placeStats').innerHTML = `
            <div class="stat"><i data-lucide="users"></i><span>${p.max_guests || 'â€”'} ${t('max_guests')}</span></div>
            <div class="stat"><i data-lucide="bed-double"></i><span>${p.bedrooms || 'â€”'} ${t('bedrooms')}</span></div>
            <div class="stat"><i data-lucide="bath"></i><span>${p.bathrooms || 'â€”'} ${t('bathrooms')}</span></div>
        `;

        // Amenities
        if (p.amenities?.length) {
            document.getElementById('placeAmenities').innerHTML = p.amenities.map(a => `
                <div class="amenity-item">
                    <i data-lucide="${a.icon || 'check'}"></i>
                    <span>${isAr ? (a.name_ar || a.name_en) : (a.name_en || a.name_ar)}</span>
                </div>
            `).join('');
        }

        // Map
        initPlaceMap(p.latitude, p.longitude, !p.exact_location);

        // Access (post-booking)
        if (p.access_instructions) {
            document.getElementById('accessSection').style.display = 'block';
            document.getElementById('placeAccess').innerHTML = `
                <p>${isAr ? (p.access_instructions_ar || p.access_instructions_en) : (p.access_instructions_en || '')}</p>
                ${p.floor_number ? `<p>Ø§Ù„Ø·Ø§Ø¨Ù‚: ${p.floor_number}</p>` : ''}
                ${p.door_description ? `<p>${p.door_description}</p>` : ''}
            `;
            document.getElementById('mapNotice').style.display = 'none';
        }

        // Load reviews
        loadReviews();

        // Set date constraints
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('bookCheckIn').min = today;
        document.getElementById('bookCheckOut').min = today;

        // Re-init Lucide icons
        lucide.createIcons();
        document.title = `${document.getElementById('placeTitle').textContent} â€” Rizi`;
    }

    function renderGallery(media) {
        const gallery = document.getElementById('placeGallery');
        if (!media.length) {
            gallery.innerHTML = `<img src="${CONFIG.PLACEHOLDER_IMAGE}" alt="Property" class="gallery-main">`;
            return;
        }
        const cover = media.find(m => m.is_cover) || media[0];
        const rest = media.filter(m => m !== cover).slice(0, 4);
        gallery.innerHTML = `
            <div class="gallery-main"><img src="${cover.url}" alt="" loading="lazy"></div>
            ${rest.length ? `<div class="gallery-grid">${rest.map(m => `<img src="${m.url}" alt="" loading="lazy">`).join('')}</div>` : ''}
        `;
    }

    function initPlaceMap(lat, lng, approximate) {
        if (!lat || !lng) return;
        const container = document.getElementById('placeMap');
        if (!container) return;

        const useGoogle = typeof google !== 'undefined' && google.maps;

        if (useGoogle) {
            placeMap = new google.maps.Map(container, {
                center: { lat: lat, lng: lng },
                zoom: approximate ? 10 : 15,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                styles: [
                    { featureType: 'poi', stylers: [{ visibility: 'off' }] },
                    { featureType: 'transit', stylers: [{ visibility: 'off' }] }
                ]
            });

            if (approximate) {
                new google.maps.Circle({
                    map: placeMap,
                    center: { lat: lat, lng: lng },
                    radius: 5000,
                    fillColor: '#6C63FF',
                    fillOpacity: 0.12,
                    strokeColor: '#6C63FF',
                    strokeWeight: 2
                });
            } else {
                new google.maps.Marker({
                    position: { lat: lat, lng: lng },
                    map: placeMap,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        fillColor: '#6C63FF',
                        fillOpacity: 0.9,
                        strokeColor: '#fff',
                        strokeWeight: 2,
                        scale: 10
                    }
                });
            }
        } else if (typeof L !== 'undefined') {
            placeMap = L.map('placeMap').setView([lat, lng], approximate ? 10 : 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap'
            }).addTo(placeMap);

            if (approximate) {
                L.circle([lat, lng], { radius: 5000, color: '#2563eb', fillOpacity: 0.15, weight: 2 }).addTo(placeMap);
            } else {
                L.marker([lat, lng]).addTo(placeMap);
            }
        }
    }

    async function loadReviews() {
        const data = await api.get(`/places/${placeId}/reviews`);
        const list = document.getElementById('placeReviews');
        const reviews = data?.reviews || data || [];

        if (!reviews.length) {
            list.innerHTML = '<p class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø¹Ø¯</p>';
        } else {
            const lang = getLang();
            list.innerHTML = reviews.map(r => {
                const authorName = r.author?.first_name || 'Ø¶ÙŠÙ';
                const authorAvatar = r.author?.avatar_url
                    ? `<img src="${r.author.avatar_url}" alt="" style="width:36px;height:36px;border-radius:50%;object-fit:cover;">`
                    : `<div style="width:36px;height:36px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:0.85rem;">${authorName[0]}</div>`;
                const stars = 'â˜…'.repeat(r.rating) + 'â˜†'.repeat(5 - r.rating);
                const date = r.created_at ? new Date(r.created_at).toLocaleDateString(lang === 'ar' ? 'ar-SA' : 'en-US') : '';
                return `
                    <div class="review-item" style="display:flex;gap:12px;padding:16px 0;border-bottom:1px solid var(--border);">
                        <div style="flex-shrink:0;">${authorAvatar}</div>
                        <div style="flex:1;min-width:0;">
                            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;flex-wrap:wrap;">
                                <strong>${authorName}</strong>
                                <span style="color:#f59e0b;font-size:0.9rem;letter-spacing:1px;">${stars}</span>
                                <time style="color:var(--text-muted);font-size:0.8rem;margin-inline-start:auto;">${date}</time>
                            </div>
                            ${r.comment ? `<p style="margin:0;line-height:1.6;">${r.comment}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Check user status (can they review? have they booked?)
        if (Auth.isLoggedIn()) {
            checkUserStatus();
        }
    }

    async function checkUserStatus() {
        try {
            const status = await api.get(`/places/${placeId}/user-status`);

            // Show "booked here before" badge
            if (status.has_booked) {
                document.getElementById('bookedBadge').style.display = 'block';
            }

            // Show "write review" button
            if (status.can_review) {
                document.getElementById('writeReviewBtn').style.display = 'inline-flex';
            }
        } catch (e) {
            console.warn('User status check failed', e);
        }
    }

    // Guests counter
    function changeGuests(delta) {
        guestCount = Math.max(1, Math.min(guestCount + delta, placeData?.max_guests || 10));
        document.getElementById('guestCount').textContent = guestCount;
    }

    // Check availability + price
    async function checkAvailability() {
        if (!Auth.isLoggedIn()) {
            showToast('Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹', 'info');
            return window.location.href = '/login';
        }

        const checkIn = document.getElementById('bookCheckIn').value;
        const checkOut = document.getElementById('bookCheckOut').value;
        if (!checkIn || !checkOut) return showToast('Ø§Ø®ØªØ± Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®', 'error');

        if (new Date(checkIn) >= new Date(checkOut)) {
            return showToast('ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ØºØ§Ø¯Ø±Ø© ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¨Ø¹Ø¯ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙˆØµÙˆÙ„', 'error');
        }

        const btn = document.getElementById('bookBtn');
        btn.disabled = true;
        btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';

        try {
            const res = await api.post('/bookings/check-availability', {
                place_id: placeId,
                check_in: checkIn,
                check_out: checkOut,
                adults: guestCount
            });

            if (res.error) {
                btn.disabled = false;
                btn.textContent = t('book_now');
                return showToast(res.error, 'error');
            }
            if (!res.available) {
                btn.disabled = false;
                btn.textContent = t('book_now');
                return showToast('ØºÙŠØ± Ù…ØªØ§Ø­ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®', 'error');
            }

            // Show price summary
            document.getElementById('bookingSummary').style.display = 'block';
            document.getElementById('summaryNights').textContent = `${res.nights} Ù„ÙŠÙ„Ø© Ã— ${formatPrice(res.price_per_night)}`;
            document.getElementById('summarySubtotal').textContent = formatPrice(res.subtotal);
            document.getElementById('summaryFee').textContent = formatPrice(res.service_fee);
            document.getElementById('summaryTotal').textContent = formatPrice(res.total);

            // Change button to confirm
            btn.disabled = false;
            btn.textContent = t('confirm_booking');
            btn.onclick = createBooking;
        } catch (e) {
            btn.disabled = false;
            btn.textContent = t('book_now');
            showToast(e.error || 'ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆÙØ±', 'error');
        }
    }

    async function createBooking() {
        const checkIn = document.getElementById('bookCheckIn').value;
        const checkOut = document.getElementById('bookCheckOut').value;

        const btn = document.getElementById('bookBtn');
        btn.disabled = true;
        btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø¬Ø²...';

        try {
            const res = await api.post('/bookings', {
                place_id: placeId,
                check_in: checkIn,
                check_out: checkOut,
                adults: guestCount
            });

            if (res.error) {
                btn.disabled = false;
                btn.textContent = t('confirm_booking');
                return showToast(res.error_ar || res.error, 'error');
            }

            const bookingId = res.booking?.id || res.id;
            if (!bookingId) {
                showToast('ØªÙ… Ø§Ù„Ø­Ø¬Ø² Ù„ÙƒÙ† Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²', 'warning');
                return setTimeout(() => window.location.href = '/bookings', 1500);
            }

            showToast('ØªÙ… Ø§Ù„Ø­Ø¬Ø² Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            setTimeout(() => window.location.href = `/booking/${bookingId}`, 1000);
        } catch (e) {
            btn.disabled = false;
            btn.textContent = t('confirm_booking');
            showToast(e.error_ar || e.error || 'Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø¬Ø²', 'error');
        }
    }

    // Review modal
    let selectedRating = 0;

    function setRating(val) {
        selectedRating = val;
        document.querySelectorAll('#starRating .star').forEach(s => {
            s.classList.toggle('active', parseInt(s.dataset.val) <= val);
        });
    }

    // Hover preview for stars
    document.querySelectorAll('#starRating .star').forEach(star => {
        star.addEventListener('mouseenter', () => {
            const v = parseInt(star.dataset.val);
            document.querySelectorAll('#starRating .star').forEach(s => {
                s.style.color = parseInt(s.dataset.val) <= v ? '#fbbf24' : '#d1d5db';
            });
        });
    });
    document.getElementById('starRating')?.addEventListener('mouseleave', () => {
        document.querySelectorAll('#starRating .star').forEach(s => {
            s.style.color = '';  // revert to CSS (.active class handles it)
        });
    });

    function showReviewForm() {
        selectedRating = 0;
        document.querySelectorAll('#starRating .star').forEach(s => s.classList.remove('active'));
        document.getElementById('reviewComment').value = '';
        document.querySelectorAll('.review-breakdown select').forEach(s => s.value = '');
        document.getElementById('reviewModal').style.display = 'flex';
    }

    function closeReviewModal() {
        document.getElementById('reviewModal').style.display = 'none';
    }

    async function submitReview() {
        if (!selectedRating) return showToast('Ø§Ø®ØªØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…', 'error');
        const comment = document.getElementById('reviewComment').value.trim();

        const btn = document.getElementById('submitReviewBtn');
        btn.disabled = true;
        btn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';

        try {
            const payload = {
                rating: selectedRating,
                comment: comment || null,
                cleanliness: parseInt(document.getElementById('revCleanliness').value) || null,
                accuracy: parseInt(document.getElementById('revAccuracy').value) || null,
                location_rating: parseInt(document.getElementById('revLocation').value) || null,
                value: parseInt(document.getElementById('revValue').value) || null,
                communication: parseInt(document.getElementById('revComm').value) || null,
                check_in_rating: parseInt(document.getElementById('revCheckin').value) || null,
            };
            const res = await api.post(`/places/${placeId}/reviews`, payload);
            if (res.error) throw res;

            showToast(res.message_ar || 'Ø´ÙƒØ±Ø§Ù‹ Ù„ØªÙ‚ÙŠÙŠÙ…Ùƒ!', 'success');
            closeReviewModal();
            document.getElementById('writeReviewBtn').style.display = 'none';
            loadReviews();
        } catch (e) {
            showToast(e.error_ar || e.error || 'ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…', 'error');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…';
        }
    }

    lucide.createIcons();
</script>
</body>
</html>
