<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تسجيل الدخول — Rizi</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/main.css">
    <link rel="stylesheet" href="/static/css/login.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body>

<!-- ─── NAVBAR (minimal) ─── -->
<nav class="nav">
    <div class="container nav__inner">
        <a href="/" class="nav__logo"><img src="/static/images/logo.png" alt="Rizi" class="nav__logo-img"> Rizi</a>
        <div class="nav__actions">
            <button class="btn btn--icon" onclick="toggleLanguage()" title="Language">
                <span id="langLabel">EN</span>
            </button>
            <button class="btn btn--icon" onclick="toggleTheme()" title="Theme">
                <i data-lucide="sun"></i>
            </button>
        </div>
    </div>
</nav>

<!-- ─── LOGIN CARD ─── -->
<main class="login-page">
    <div class="login-card">
        <div class="login-card__header">
            <h1 data-t="login">تسجيل الدخول</h1>
            <p>ادخل بريدك الإلكتروني للمتابعة</p>
        </div>

        <!-- Step 1: Email -->
        <div id="stepEmail" class="login-step active">
            <div class="form-group">
                <label for="loginEmail" data-t="enter_email">أدخل بريدك الإلكتروني</label>
                <input type="email" id="loginEmail" class="form-input" placeholder="example@email.com" required>
            </div>
            <button class="btn btn--primary btn--block" onclick="sendOTP()" data-t="send_otp">
                إرسال رمز التحقق
            </button>
            <div class="login-divider"><span data-t="or">أو</span></div>
            <button class="btn btn--outline btn--block" onclick="sendMagicLink()">
                <i data-lucide="link"></i>
                <span data-t="send_magic_link">إرسال رابط الدخول</span>
            </button>
        </div>

        <!-- Step 2: OTP Verification -->
        <div id="stepOTP" class="login-step">
            <p class="login-info">تم إرسال رمز التحقق إلى <strong id="otpEmail"></strong></p>
            <div class="otp-inputs">
                <input type="text" maxlength="1" class="otp-input" data-idx="0" inputmode="numeric">
                <input type="text" maxlength="1" class="otp-input" data-idx="1" inputmode="numeric">
                <input type="text" maxlength="1" class="otp-input" data-idx="2" inputmode="numeric">
                <input type="text" maxlength="1" class="otp-input" data-idx="3" inputmode="numeric">
                <input type="text" maxlength="1" class="otp-input" data-idx="4" inputmode="numeric">
                <input type="text" maxlength="1" class="otp-input" data-idx="5" inputmode="numeric">
            </div>
            <button class="btn btn--primary btn--block" onclick="verifyOTP()">
                تأكيد
            </button>
            <button class="btn btn--text" onclick="goBackToEmail()">← رجوع</button>
        </div>

        <!-- Step 3: Magic Link Sent -->
        <div id="stepMagic" class="login-step">
            <div class="login-success">
                <i data-lucide="mail-check" class="login-success__icon"></i>
                <h2>تم إرسال الرابط!</h2>
                <p>تحقق من بريدك الإلكتروني وانقر على رابط الدخول</p>
            </div>
            <button class="btn btn--text" onclick="goBackToEmail()">← رجوع</button>
        </div>

        <!-- Owner Registration -->
        <div class="login-owner">
            <p data-t="owner_register">سجّل كمالك عقار</p>
            <a href="#" class="btn btn--outline btn--sm" onclick="showOwnerForm()">
                <i data-lucide="building-2"></i> تسجيل
            </a>
        </div>

        <!-- Step: Owner Registration -->
        <div id="stepOwner" class="login-step">
            <h2 style="text-align:center;margin-bottom:0.5rem;"><i data-lucide="building-2" style="width:24px;height:24px;display:inline;"></i> تسجيل مالك عقار</h2>
            <p style="text-align:center;color:var(--text-muted);margin-bottom:1.5rem;font-size:0.9rem;">أنشئ حسابك وأضف عقارك مباشرة</p>

            <div class="form-group">
                <label>الاسم الأول *</label>
                <input type="text" id="ownerFirstName" class="form-input" placeholder="مثال: أحمد" required>
            </div>
            <div class="form-group">
                <label>اسم العائلة *</label>
                <input type="text" id="ownerLastName" class="form-input" placeholder="مثال: القحطاني" required>
            </div>
            <div class="form-group">
                <label>البريد الإلكتروني *</label>
                <input type="email" id="ownerEmail" class="form-input" placeholder="example@email.com" dir="ltr" required>
            </div>
            <div class="form-group">
                <label>رقم الجوال *</label>
                <input type="tel" id="ownerPhone" class="form-input" placeholder="05XXXXXXXX" dir="ltr" required>
            </div>
            <div class="form-group">
                <label>كلمة المرور *</label>
                <input type="password" id="ownerPassword" class="form-input" placeholder="••••••••" required>
            </div>

            <button class="btn btn--primary btn--block" id="ownerRegBtn" onclick="registerOwner()">
                <i data-lucide="user-plus"></i> إنشاء الحساب
            </button>
            <p id="ownerRegError" style="display:none;color:var(--danger);text-align:center;margin-top:0.75rem;"></p>
            <button class="btn btn--text" onclick="goBackToEmail()" style="margin-top:0.5rem;">← رجوع لتسجيل الدخول</button>
        </div>
    </div>
</main>

<script src="/static/js/config.js"></script>
<script src="/static/js/i18n.js"></script>
<script src="/static/js/auth.js"></script>
<script>
    // Redirect if already logged in
    if (Auth.isLoggedIn()) window.location.href = '/';

    let currentEmail = '';

    async function sendOTP() {
        const email = document.getElementById('loginEmail').value.trim();
        if (!email) return showToast('أدخل بريدك الإلكتروني', 'error');
        currentEmail = email;

        const res = await Auth.requestOTP(email);
        if (res.error) return showToast(res.error, 'error');

        document.getElementById('otpEmail').textContent = email;
        showStep('stepOTP');
        // Focus first OTP input
        document.querySelector('.otp-input[data-idx="0"]')?.focus();
        showToast('تم إرسال رمز التحقق', 'success');
    }

    async function sendMagicLink() {
        const email = document.getElementById('loginEmail').value.trim();
        if (!email) return showToast('أدخل بريدك الإلكتروني', 'error');

        const res = await Auth.requestMagicLink(email);
        if (res.error) return showToast(res.error, 'error');

        showStep('stepMagic');
        showToast('تم إرسال رابط الدخول', 'success');
    }

    async function verifyOTP() {
        const inputs = document.querySelectorAll('.otp-input');
        const code = Array.from(inputs).map(i => i.value).join('');
        if (code.length !== 6) return showToast('أدخل الرمز كاملاً', 'error');

        const res = await Auth.verifyOTP(currentEmail, code);
        if (res.error) return showToast(res.error, 'error');

        showToast('تم تسجيل الدخول بنجاح!', 'success');
        setTimeout(() => window.location.href = '/', 800);
    }

    function goBackToEmail() {
        showStep('stepEmail');
    }

    function showStep(id) {
        document.querySelectorAll('.login-step').forEach(s => s.classList.remove('active'));
        document.getElementById(id)?.classList.add('active');
    }

    function showOwnerForm() {
        showStep('stepOwner');
        document.getElementById('ownerFirstName')?.focus();
    }

    async function registerOwner() {
        const firstName = document.getElementById('ownerFirstName').value.trim();
        const lastName = document.getElementById('ownerLastName').value.trim();
        const email = document.getElementById('ownerEmail').value.trim();
        const phone = document.getElementById('ownerPhone').value.trim();
        const password = document.getElementById('ownerPassword').value;
        const errorEl = document.getElementById('ownerRegError');
        errorEl.style.display = 'none';

        if (!firstName || !lastName || !email || !phone || !password) {
            errorEl.textContent = 'جميع الحقول مطلوبة';
            errorEl.style.display = 'block';
            return;
        }
        if (password.length < 6) {
            errorEl.textContent = 'كلمة المرور يجب أن تكون 6 أحرف على الأقل';
            errorEl.style.display = 'block';
            return;
        }

        const btn = document.getElementById('ownerRegBtn');
        btn.disabled = true;
        btn.innerHTML = '<i data-lucide="loader-2" class="spin"></i> جاري التسجيل...';
        if (typeof lucide !== 'undefined') lucide.createIcons();

        try {
            const res = await Auth.registerOwner({
                first_name: firstName,
                last_name: lastName,
                email: email,
                phone: phone,
                password: password
            });

            if (res.access_token) {
                showToast('تم التسجيل بنجاح! جاري التوجيه لإضافة عقارك...', 'success');
                setTimeout(() => window.location.href = '/owner', 1000);
            } else {
                errorEl.textContent = res.error_ar || res.error || 'حدث خطأ';
                errorEl.style.display = 'block';
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="user-plus"></i> إنشاء الحساب';
                if (typeof lucide !== 'undefined') lucide.createIcons();
            }
        } catch (e) {
            errorEl.textContent = e.error_ar || e.error || 'حدث خطأ أثناء التسجيل';
            errorEl.style.display = 'block';
            btn.disabled = false;
            btn.innerHTML = '<i data-lucide="user-plus"></i> إنشاء الحساب';
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }
    }

    // OTP input auto-advance
    document.querySelectorAll('.otp-input').forEach(input => {
        input.addEventListener('input', e => {
            const val = e.target.value;
            if (val && val.length === 1) {
                const next = e.target.nextElementSibling;
                if (next && next.classList.contains('otp-input')) next.focus();
            }
        });
        input.addEventListener('keydown', e => {
            if (e.key === 'Backspace' && !e.target.value) {
                const prev = e.target.previousElementSibling;
                if (prev && prev.classList.contains('otp-input')) prev.focus();
            }
        });
    });

    // Init icons
    lucide.createIcons();
</script>
</body>
</html>
